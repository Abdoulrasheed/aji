{% extends 'app/base.html' %}
{% load static %}

{% block main %}
    <div class="page-content">
    <!--Main content-->
      <div class="col-md-12">
        <div id="capture" class="content-box-large">
          <div class="panel-heading">
          <div class="panel-title">Bar & Summary Table for <span class="text-primary" id="date_label"></span></div>

          <div class="panel-options">
            <a title="Download Image report" id="download_img" href="#"><i class="glyphicon glyphicon-download-alt"></i></a>

             <a target="blank" title="Download PDF report" id="download_pdf"><i class="glyphicon glyphicon-file"></i></a>

            <a title="Reload Table" onclick="location.reload()" data-rel="collapse"><i class="glyphicon glyphicon-refresh"></i></a>
          </div>
        </div>
          <div class="panel-body">
            <div class="row">
              <div class="col-md-8">
                <canvas id="myChart" width="400" height="180"></canvas>
                 <img class="loader" hidden src="{% static 'app/images/loader.gif' %}">
              </div>
              <div class="col-md-3">
              <span id="data_url" url="{% url 'api_load_graph_data' %}"></span>
              <span id="download_pdf_url" url="{# {% url 'generate_report' %} #}"></span>
                <table class="table table-striped table-bordered" id="example">
                  <thead>
                    <tr>
                      <th>Vehicle Type</th>
                      <th>Amount</th>
                      <th>Total</th>
                    </tr>
                  </thead>
                  <tbody class="v_detail">
                    <tr>
                      <td colspan="2">
                        <img class="loader" hidden src="{% static 'app/images/loader.gif' %}">
                      </td>
                      </tr>
                  </tbody>
                  <tr>
                      <th colspan="2">TOTAL</th>
                      <td class="v_total"></td>
                  </tr>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
      {% endblock main %}
      {% block js %}
      <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
      <script src="{% static 'app/js/graph.js' %}"></script>
      <script src="https://cdn.datatables.net/1.10.18/js/jquery.dataTables.min.js"></script>
    <script src="{% static 'app/js/tables.js' %}"></script>
    <script src="http://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
      <script>
        var dwn = document.querySelector('#download_img');
        const done = ()=> {
          html2canvas(document.querySelector("#capture")).then(canvas => {
            var context = canvas.getContext("2d");
            var img = new Image();
            img.onload = ()=> {
              context.drawImage(img, 0, 0);
            };

            var strDataURI = canvas.toDataURL();
            var url_base64 = document.getElementById('myChart').toDataURL('image/png');
            img.src = strDataURI;
            dwn.setAttribute('href', url_base64);
          });

          dwn.addEventListener('click', () => {
            dwn.setAttribute('download', 'Chart Report.png');
          });
        }
      </script>

      <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
          <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
      <script>
        $(function() {
          const url = $("#data_url").attr('url')
          $('input[name="daterange"]').daterangepicker({
              opens: 'left'
            }, function(start, end, label) {
            $.ajax({
              url: url,
              data:{
                'start': start.format('YYYY-MM-DD'),
                'end': end.format('YYYY-MM-DD')
              },

              beforeSend: ()=>{
                  $('.loader').removeAttr('hidden');
                },

              complete: ()=>{
                  $('.loader').attr('hidden', true);
                },
                
              success: (data)=>{
                if (data == 'NoData'){
                  alert('No data within the selected date range')
                }else{
                  total = data.total
                  html_detail = data.q
                  setData(total, html_detail);

                  labels = data.labels
                  values = data.values
                  setGraph(labels, values);
                }
              }
            });
          });
        });
      </script>
{% endblock js %}